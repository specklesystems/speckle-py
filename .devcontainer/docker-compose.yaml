version: "3.3"  # optional since v1.27.0
services:
  postgres:
    image: circleci/postgres:12
    environment:
      POSTGRES_DB: speckle2_test
      POSTGRES_PASSWORD: speckle
      POSTGRES_USER: speckle
      # ports:
      #   - "5432:5432"
    network_mode: host
  redis:
    image: circleci/redis:6
    # ports:
    #   - "6379:6379"
    network_mode: host
  speckle-server:
    image: speckle/speckle-server
    command: ["bash", "-c", "/wait && node bin/www"]
    environment:
      POSTGRES_URL: "localhost"
      POSTGRES_USER: "speckle"
      POSTGRES_PASSWORD: "speckle"
      POSTGRES_DB: "speckle2_test"
      REDIS_URL: "redis://localhost"
      SESSION_SECRET: "keyboard cat"
      STRATEGY_LOCAL: "true"
      CANONICAL_URL: "http://localhost:3000"
      WAIT_HOSTS: localhost:5432, localhost:6379
    # ports:
    #   - "3000:3000"
    network_mode: host

  specklepy:
    build:
      dockerfile: Dockerfile
      context: .
      args:
        VARIANT: 3.9
        NODE_VERSION: lts/*
    volumes:
      # Mounts the project folder to '/workspace'. While this file is in .devcontainer,
      # mounts are relative to the first file in the list, which is a level up.
      - ..:/workspaces/specklepy:cached
    # Overrides default command so things don't shut down after the process ends.
    command: /bin/sh -c "while sleep 1000; do :; done"
    network_mode: host
# networks:
#     default: